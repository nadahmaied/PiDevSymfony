{% extends 'baseFront.html.twig' %}

{% block title %}Missions de Bénévolat{% endblock %}

{% block body %}
    <div class="p-8 space-y-8">
        
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
            <form method="get" class="flex items-center bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 w-full md:w-1/2 transition focus-within:ring-2 focus-within:ring-orange-200 focus-within:bg-white">
                <i class="fa-solid fa-magnifying-glass text-gray-400 mr-3"></i>
                <input type="text" name="q" value="{{ app.request.query.get('q') }}" placeholder="Rechercher une mission (titre, lieu...)" class="bg-transparent border-none outline-none text-sm w-full text-gray-600 placeholder-gray-400 focus:ring-0">
            </form>

            <a href="{{ path('app_front_volunteer_index') }}" class="text-blue-600 bg-blue-50 font-medium text-sm hover:bg-blue-100 px-5 py-2.5 rounded-xl transition flex items-center shadow-sm">
                <i class="fa-solid fa-list-check mr-2"></i>Mes candidatures
            </a>
        </div>

        <div class="bg-gradient-to-r from-orange-500 to-amber-500 rounded-3xl p-8 text-white shadow-xl relative overflow-hidden">
            <div class="relative z-10 max-w-2xl">
                <h2 class="text-3xl font-bold mb-2">Donnez de votre temps, sauvez des vies.</h2>
                <p class="text-orange-100 mb-6 text-lg">Rejoignez notre réseau de volontaires.</p>
            </div>
            <i class="fa-solid fa-handshake-angle absolute -bottom-10 -right-10 text-9xl text-white opacity-20 transform -rotate-12"></i>
        </div>

        <div class="flex justify-between items-center px-2">
            <p class="text-gray-500 text-sm">
                <span class="font-bold text-gray-800 text-lg">{{ pagination.getTotalItemCount }}</span> missions disponibles
            </p>
            {% if app.request.query.get('q') %}
                <a href="{{ path('app_missions_index') }}" class="text-sm text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-full transition flex items-center">
                    <i class="fa-solid fa-xmark mr-1"></i> Effacer la recherche
                </a>
            {% endif %}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {% for mission in pagination %}
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden group hover:shadow-xl hover:-translate-y-1 transition duration-300 flex flex-col h-full relative">
                    
                    <div class="h-52 bg-gray-200 relative overflow-hidden">
                        <img src="{{ mission.photo ? asset('uploads/missions/' ~ mission.photo) : 'https://images.unsplash.com/photo-1593113598332-cd288d649433?w=500' }}" 
                             alt="{{ mission.titre }}" 
                             class="w-full h-full object-cover group-hover:scale-110 transition duration-700">
                        
                        {% if mission.statut == 'Ouverte' %}
                            <span class="absolute top-3 right-3 bg-white/90 backdrop-blur text-orange-600 text-xs font-bold px-3 py-1.5 rounded-full shadow-sm flex items-center gap-1">
                                <i class="fa-solid fa-bolt"></i> Nouveau
                            </span>
                        {% endif %}

                        <button data-url="{{ path('app_mission_like_action', {'id': mission.id}) }}" 
                           class="js-like-button absolute top-3 left-3 bg-white/90 backdrop-blur w-9 h-9 rounded-full shadow-sm flex items-center justify-center transition hover:scale-110 group/heart">
                            <i class="fa-heart text-lg transition-colors
                               {% if app.user and mission.missionLikes|filter(l => l.user == app.user)|length > 0 %} 
                                   fa-solid text-red-500 
                               {% else %} 
                                   fa-regular text-gray-400 group-hover/heart:text-red-500 
                               {% endif %}">
                            </i>
                        </button>
                    </div>

                    <div class="p-6 flex flex-col flex-1">
                        
                        <div class="flex items-center gap-2 text-xs text-gray-500 mb-3">
                            <span class="bg-gray-50 border border-gray-100 px-2 py-1 rounded-md flex items-center gap-1">
                                <i class="fa-solid fa-location-dot text-orange-400"></i> {{ mission.lieu }}
                            </span>
                            <span class="bg-gray-50 border border-gray-100 px-2 py-1 rounded-md flex items-center gap-1">
                                <i class="fa-regular fa-calendar text-blue-400"></i> {{ mission.dateDebut|date('d M') }}
                            </span>
                        </div>
                        
                        <h4 class="font-bold text-xl text-gray-800 mb-2 group-hover:text-orange-600 transition line-clamp-1" title="{{ mission.titre }}">
                            {{ mission.titre }}
                        </h4>

                        <div class="flex items-center mb-4 text-xs gap-1">
                            {% set totalRating = 0 %}
                            {% for r in mission.missionRatings %}
                                {% set totalRating = totalRating + r.note %}
                            {% endfor %}
                            {% set avg = mission.missionRatings|length > 0 ? (totalRating / mission.missionRatings|length) : 0 %}

                            <div class="flex text-yellow-400">
                                {% for i in 1..5 %}
                                    <i class="{{ i <= avg ? 'fa-solid' : 'fa-regular' }} fa-star"></i>
                                {% endfor %}
                            </div>
                            <span class="text-gray-400 text-xs ml-1">({{ mission.missionRatings|length }} avis)</span>
                        </div>
                        
                        <p class="text-sm text-gray-500 mb-6 flex-1 line-clamp-3 leading-relaxed">
                            {{ mission.description }}
                        </p>
                        
                        <div class="mt-auto pt-4 border-t border-gray-50 flex items-center justify-between">
                            <span class="text-xs font-semibold text-gray-400 bg-gray-50 px-2 py-1 rounded">
                                Places limitées
                            </span>
                            
                            <a href="{{ path('app_mission_show', {'id': mission.id}) }}" 
                               class="bg-orange-50 text-orange-600 border border-orange-100 px-5 py-2 rounded-lg font-bold text-sm hover:bg-orange-600 hover:text-white hover:border-transparent transition shadow-sm">
                                Voir détails
                            </a>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col-span-1 md:col-span-2 lg:col-span-3 flex flex-col items-center justify-center py-16 text-gray-500 bg-white rounded-2xl shadow-sm border border-gray-100">
                    <div class="bg-gray-50 p-6 rounded-full mb-4">
                        <i class="fa-solid fa-magnifying-glass text-4xl text-gray-300"></i>
                    </div>
                    <p class="text-lg font-medium">Aucune mission ne correspond à votre recherche.</p>
                    <a href="{{ path('app_missions_index') }}" class="text-orange-600 hover:underline mt-2">Voir toutes les missions</a>
                </div>
            {% endfor %}
        </div>

        <div class="mt-8 flex justify-center pb-8">
            {{ knp_pagination_render(pagination) }}
        </div>
    </div>

<script>
    document.querySelectorAll('.js-like-button').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const url = this.dataset.url;
            const icon = this.querySelector('i');
            
            this.classList.add('scale-125');
            setTimeout(() => this.classList.remove('scale-125'), 200);

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        if (data.isLiked) {
                            icon.classList.remove('fa-regular', 'text-gray-400');
                            icon.classList.add('fa-solid', 'text-red-500');
                        } else {
                            icon.classList.remove('fa-solid', 'text-red-500');
                            icon.classList.add('fa-regular', 'text-gray-400');
                        }
                    } else if (data.code === 403) {
                        alert("Veuillez vous connecter pour ajouter aux favoris !");
                    }
                })
                .catch(err => console.error('Erreur:', err));
        });
    });
</script>
{% endblock %}