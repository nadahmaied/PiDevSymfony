{% extends 'baseBack.html.twig' %}

{% block title %}Modération Forum{% endblock %}

{% block body %}
    <div class="p-8">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Modération du Forum</h1>
                <p class="text-sm text-gray-500 mt-1">
                    <span class="font-bold text-blue-600">{{ pagination.getTotalItemCount }}</span> sujets trouvés
                </p>
            </div>
            
            <a href="{{ path('app_admin_forum_new') }}" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition font-bold text-sm flex items-center gap-2 shadow-sm">
                <i class="fa-solid fa-plus"></i> Nouveau sujet
            </a>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6">
            <form method="get" class="flex gap-2">
                <div class="relative flex-1">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" name="q" value="{{ app.request.query.get('q') }}" placeholder="Rechercher (titre, contenu, auteur)..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-100 focus:border-orange-300 outline-none transition">
                </div>
                <button type="submit" class="bg-gray-800 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition font-medium">
                    Filtrer
                </button>
                {% if app.request.query.get('q') %}
                    <a href="{{ path('app_admin_forum_index') }}" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg hover:bg-red-100 transition flex items-center" title="Effacer la recherche">
                        <i class="fa-solid fa-xmark"></i>
                    </a>
                {% endif %}
            </form>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 text-gray-600 text-xs uppercase">
                    <tr>
                        <th class="px-6 py-4 hover:bg-gray-100 transition cursor-pointer">
                            {{ knp_pagination_sortable(pagination, 'Date', 'q.dateCreation') }}
                        </th>
                        <th class="px-6 py-4 hover:bg-gray-100 transition cursor-pointer">
                            {{ knp_pagination_sortable(pagination, 'Auteur', 'u.email') }}
                        </th>
                        <th class="px-6 py-4 hover:bg-gray-100 transition cursor-pointer">
                            {{ knp_pagination_sortable(pagination, 'Sujet', 'q.titre') }}
                        </th>
                        <th class="px-6 py-4 text-center">Réponses</th>
                        <th class="px-6 py-4 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 text-sm">
                    {# ATTENTION : On boucle sur 'pagination' maintenant #}
                    {% for question in pagination %}
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-6 py-4 text-gray-500 whitespace-nowrap">
                                {{ question.dateCreation|date('d/m/Y H:i') }}
                            </td>
                            <td class="px-6 py-4 font-medium text-gray-800">
                                {{ question.auteur ? question.auteur.email : 'Anonyme' }}
                            </td>
                            <td class="px-6 py-4">
                                <p class="font-bold text-gray-700 truncate w-64" title="{{ question.titre }}">{{ question.titre }}</p>
                                <p class="text-xs text-gray-400 truncate w-64">{{ question.contenu }}</p>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-md text-xs font-bold">
                                    {{ question.reponses|length }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <a href="{{ path('app_admin_forum_show', {'id': question.id}) }}" class="bg-blue-50 text-blue-600 p-2 rounded hover:bg-blue-600 hover:text-white transition" title="Voir / Modérer">
                                        <i class="fa-solid fa-eye"></i>
                                    </a>

                                    <a href="{{ path('app_admin_forum_edit', {'id': question.id}) }}" class="bg-yellow-50 text-yellow-600 p-2 rounded hover:bg-yellow-500 hover:text-white transition" title="Modifier">
                                        <i class="fa-solid fa-pen"></i>
                                    </a>

                                    <form method="post" action="{{ path('app_admin_forum_delete_question', {'id': question.id}) }}" onsubmit="return confirm('Supprimer ce sujet et toutes ses réponses ?');">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ question.id) }}">
                                        <button class="bg-red-50 text-red-600 p-2 rounded hover:bg-red-600 hover:text-white transition" title="Supprimer">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-12">
                                <div class="flex flex-col items-center text-gray-400">
                                    <i class="fa-regular fa-comments text-4xl mb-3 opacity-20"></i>
                                    <p>Aucun sujet ne correspond à votre recherche.</p>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-6 flex justify-center">
            {{ knp_pagination_render(pagination) }}
        </div>
    </div>
{% endblock %}